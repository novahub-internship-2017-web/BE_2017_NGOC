<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="/"><i class="fa fa-home" style="font-size: 26px"></i> Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="nav navbar-nav mr-auto"></ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#exampleModal" id="btn-sign-up">Sign up</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#exampleModal" id="btn-sign-in">Sign in</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="row" style="margin-top: 150px;">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <div id="search_book">
                <div class="form-group row">
                    <div class="col-md-1"></div>
                    <div class="col-md-9">
                        <input type="text" id="text-search" class="form-control" />
                    </div>
                    <div class="col-md-1">
                        <input type="button" id="btn-search" class="btn btn-primary" value="Search"/>
                    </div>
                    <div class="col-md-1"></div>
                </div>
            </div>

            <div id="body">
                <div style="margin-top: 10px;" align="center">
                    <p style="display: inline;">Size : </p>
                    <select id="size-books-response"class="custom-select" style="width: 70px;" onchange="onChangeSelect()">
                      <option value="3" selected>3</option>
                      <option value="6">6</option>
                      <option value="9">9</option>
                      <option value="12">12</option>
                    </select>

                    <p style="display: inline; margin-left: 10px;">Order by : </p>
                    <select id="sort-books-response"class="custom-select" style="width: 150px;" onchange="onChangeSelect()">
                      <option value="id" selected>id</option>
                      <option value="title">title</option>
                      <option value="author">author</option>
                      <option value="description">description</option>
                      <option value="enabled">enabled</option>
                    </select>

                    <select id="asc-desc-books-response"class="custom-select" style="width: 90px;" onchange="onChangeSelect()">
                      <option value="asc" selected>asc</option>
                      <option value="desc">desc</option>
                    </select>
                </div>

                <table id="books-list" style="display: none; margin-top: 20px;" class="table table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">id</th>
                            <th scope="col">Title</th>
                            <th scope="col">Author</th>
                        </tr>
                    </thead>
                </table>
                <div align="center"> <a id="load-more-books" class="btn btn-success" style="display: none; color: white;">Load more</a> </div>
                <div id="div-book-not-found" align="center" style="display: none">
                    <p style="font-size: 30px">Book not found</p>
                </div>

                <!-- <nav aria-label="Page navigation example">
                  <ul class="pagination">
                    <li class="page-item"><a class="page-link" href="#">Previous</a></li>
                    <li class="page-item"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item"><a class="page-link" href="#">Next</a></li>
                  </ul>
                </nav> -->
            </div>
        </div>
        <div class="col-md-2">             
        </div>
    </div>

    <div class="alert alert-success" id="alert-success-message" style="display: none; margin-top: 65px;">
        <p style="text-align: center; margin-bottom: 0px;">
            <strong>Success!</strong> You have successfully signed up as a user.
        </p>
    </div>


    <div class="modal" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="form-group">
                            <h2 style="text-align: center" id="form-title">Please Login</h2>
                        </div>                              
                        <div class="alert alert-danger" id="alert-error-message" style="display: none;">
                            <p style="text-align: center; margin-bottom: 0px;">
                                <strong>Danger!</strong> <span id="error-message"></span>.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="col-form-label">Email : </label>
                            <input type="text" name="email" id="email" class="form-control"/>
                        </div>
                        <div class="form-group">
                            <label class="col-form-label">Password : </label>
                            <input type="password" name="password" id="password" class="form-control"/>
                        </div>
                        <div class="form-group" id="group-repassword">
                            <label class="col-form-label">Comfirm password : </label>
                            <input type="password" name="repassword" id="re-password" class="form-control"/>
                        </div>
                        <div class="form-group" id="group-first-name">
                            <label class="col-form-label" >First name : </label>
                            <input type="text" name="firstName" id="first-name" class="form-control"/>
                        </div>
                        <div class="form-group" id="group-last-name">
                            <label class="col-form-label">Last name : </label>
                            <input type="text" name="lastName" id="last-name" class="form-control"/>
                        </div>
                        <div class="form-group" style="margin-top: 15px">
                            <input type="submit" name="submit" id="btn-action" class="btn btn-primary form-control"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="book-view-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" >
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-1"></div>
                        <div class="col-lg-10">   
                            <!-- <h2>Title : </h2> -->
                            <h2 id="title-book-view"></h2>
                            <h4 id="author-book-view" style="font-size : 15px;"></h4>

                            <p id="description-book-view" style="margin-top: 10px;"></p>
                            <h2>Comment : </h2>
                            <div id="comments">
                                <div id="comments-list">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div> 

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <style type="text/css">
        .form-group {
            margin-bottom: 0px;
        }

        label.error {
            color: red;
            font-style: italic;
            font-size: 12px;
        }
    </style>

    <script>
        const BTN_SIGN_UP_PRESSED = 1;
        const BTN_SIGN_IN_PRESSED = 2;


        const OK = 0;
        const EMAIL_IS_EXIST = 11;
        const EMAIL_OR_PASSWORD_WRONG = 12;
        const USER_IS_BLOCKED = 25;

        const ROLE_ADMIN = "ADMIN";
        const ROLE_USER = "USER";

        var stateButtonFormLoginPressed;

        $("#login-form").click( function(event){
            $("#alert-error-message").hide();
            $("#alert-success-message").hide();
        });

        $("#btn-sign-up").click( function(envet){
            $("#form-title").text("Please Sign Up");
            $("#re-password").prop("disabled", false);
            $("#first-name").prop("disabled", false);
            $("#last-name").prop("disabled", false);
            $("#group-repassword").show();
            $("#group-first-name").show();
            $("#group-last-name").show();
            $("#btn-action").val("Sign up");

            if(stateButtonFormLoginPressed != BTN_SIGN_UP_PRESSED){
                clearForm();
                clearErrorMessages();
            }
            stateButtonFormLoginPressed = BTN_SIGN_UP_PRESSED;
            
        });

        $("#btn-sign-in").click( function(envet){
            $("#form-title").text("Please Sign In");
            $("#re-password").prop("disabled", true);
            $("#first-name").prop("disabled", true);
            $("#last-name").prop("disabled", true);            
            $("#group-repassword").hide();
            $("#group-first-name").hide();
            $("#group-last-name").hide();
            $("#btn-action").val("Sign in");

            if(stateButtonFormLoginPressed != BTN_SIGN_IN_PRESSED){
                clearForm();
                clearErrorMessages(); 
            }            

            stateButtonFormLoginPressed = BTN_SIGN_IN_PRESSED;
            
        });

        function clearErrorMessages(){
            $("#alert-success-message").hide();
            $("#alert-error-message").hide();
            $(".error").hide();
            $("#email").css("border-color", "#ced4da");
            $("#password").css("border-color", "#ced4da");
            $("#repassword").css("border-color", "#ced4da");
            $("#firstName").css("border-color", "#ced4da");
            $("#lastName").css("border-color", "#ced4da");
        }

        function clearForm(){
            $(".error").hide();
            $("#email").val("");
            $("#email").css("border-color", "#ced4da");
            $("#password").val("");
            $("#password").css("border-color", "#ced4da");
            $("#repassword").val("");
            $("#repassword").css("border-color", "#ced4da");
            $("#firstName").val("");
            $("#firstName").css("border-color", "#ced4da");
            $("#lastName").val("");
            $("#lastName").css("border-color", "#ced4da");
        }

        $("#login-form").submit(function(event) {
            event.preventDefault();
            var data;

            if(stateButtonFormLoginPressed == BTN_SIGN_UP_PRESSED){
                data = JSON.stringify({
                    "email" : $('#email').val(),
                    "password" : $('#password').val(),
                    "firstName" : $('#first-name').val(),
                    "lastName" : $('#last-name').val()
                });
            }

            if($("#login-form").valid() ) {
                switch(stateButtonFormLoginPressed){
                    case BTN_SIGN_UP_PRESSED : 
                        {
                            $.ajax({
                                type: "POST",
                                contentType: "application/json",
                                url: window.location.origin + "/api/user",
                                data: data,
                                dataType: 'json',
                                timeout: 10000,
                                success: function (data) {
                                    switch(data.code)
                                    {
                                        case OK:
                                            {                                                
                                                clearForm();    
                                                $("#exampleModal").modal('hide'); 
                                                $("#alert-success-message").show();
                                                $("#alert-error-message").hide();
                                            }
                                            break;

                                        case EMAIL_IS_EXIST:
                                            {
                                                $("#alert-error-message").show();
                                                $("#alert-success-message").hide();
                                                $("#error-message").text("Email is exist");
                                            }
                                            break;

                                        
                                    }
                                                                   
                                },
                                error: function (e) {
                                    // TODO: show message network 
                                }
                            });
                        }
                        break;
                    case BTN_SIGN_IN_PRESSED :
                        {
                            $.ajax({
                                type: "GET",
                                contentType: "application/json",
                                url: window.location.origin + "/api/user",
                                headers: 
                                {
                                    "email"     : $('#email').val(), 
                                    "password"  : $('#password').val()
                                },
                                dataType: 'json',
                                timeout: 10000,
                                success: function (data) {
                                    switch(data.code)
                                    {
                                        case OK:
                                            {                                                
                                                if(data.object.name == ROLE_ADMIN){
                                                    window.location.replace(window.location.origin + "/admin/home");
                                                } 

                                                if(data.object.name == ROLE_USER){
                                                    window.location.replace(window.location.origin + "/user/home");
                                                }
                                            }
                                            break;

                                        case EMAIL_OR_PASSWORD_WRONG:
                                            {
                                                $("#alert-error-message").show();
                                                $("#alert-success-message").hide();
                                                $("#error-message").text("Email or Password incorrect");
                                            }
                                            break;

                                        case USER_IS_BLOCKED:
                                            {
                                                $("#alert-error-message").show();
                                                $("#alert-success-message").hide();
                                                $("#error-message").text("User is blocked");
                                            }
                                            break;
                                    }
                                },
                                error: function (e) {
                                    $("#alert-error-message").show();
                                    $("#alert-success-message").hide();
                                    $("#error-message").text(e.responseJSON.message.trim());
                                }
                            });
                        }
                        break;
                }
            }
        });

        // validation
        $(document).ready(function(s) {
            $("#login-form").validate({
                highlight : 
                    function(element, errorClass) {
                        $(element).css("border-color", "#d9534f");
                    },
                unhighlight : 
                    function(element, errorClass) {
                        $(element).css("border-color", "#5cb85c");
                    },
                rules:{
                    email : {
                        required: true,
                        email: true
                    },
                    password: {
                        required: true
                    },
                    repassword: {
                        equalTo: "#password"
                    }
                },
                messages :{
                    email : {
                        required: "Email is not empty",
                        email: "Your email address must be in the format of name@domain.com"
                    },
                    password: {
                        required: "Password is not empty"
                    },
                    repassword: {
                        equalTo: "Password does not match the confirm password"
                    }
                }
            });
        });
    </script> 

    <script> 
        function showAlert() {
            $("#success-alert").fadeTo(1000, 500).slideUp(500, function(){
                $("#success-alert").slideUp(500);
            });   
        }

        var hasSortOrSizeChanged = true;

        function onChangeSelect(){
            hasSortOrSizeChanged = true;
            pageOfPagingate = 0;
        }

        $("#load-more-books").click( function() {
            searchBooks();
        });

        var pageOfPagingate = 0;
        
        var urlRequestSearchBook, bookList, stateBookForm, wordsSearch;


        urlRequestSearchBook = window.location.origin + "/api/books/enabled";
       

        $("#btn-search").click(function () {
            wordsSearch = $("#text-search").val();
            hasSortOrSizeChanged = true;
            pageOfPagingate = 0;
            searchBooks(wordsSearch);
        });

        function searchBooks(wordsSearch){
            $.ajax({
                type: "GET",
                contentType: "application/json",
                url: urlRequestSearchBook + "?page=" + pageOfPagingate + "&size=" + $("#size-books-response").val() + "&sort=" + $("#sort-books-response").val() + "," + $("#asc-desc-books-response").val(),
                headers : {"wordsSearch" : wordsSearch},
                dataType: 'json',
                timeout: 10000,
                success: function (dataReceive) {
                    if(hasSortOrSizeChanged == true){
                        hasSortOrSizeChanged = false;
                        if(dataReceive.object.content.length === 0){
                            showMessageNotFound();
                        } else {
                            bookList = dataReceive.object.content;
                            showBooksResult(bookList);
                        }
                    } else {
                        for(var index = 0; index < dataReceive.object.content.length; index++){
                            bookList.push(dataReceive.object.content[index]);
                            showABookResult(dataReceive.object.content[index]);
                        }
                    }

                    if(dataReceive.object.last == false){
                        pageOfPagingate = pageOfPagingate + 1;
                        $("#load-more-books").show();
                    } else {
                        $("#load-more-books").hide();
                    }
                },
                error: function (e) {
                    console.log("ERROR : ", e);
                }
            });
        }

        function showMessageNotFound(){
            $("#books-list").hide();
            $("#div-book-not-found").show();
        }

        function showBooksResult(books){
            $("#books-list").show();
            $("#div-book-not-found").hide();

            $("tbody").remove();

            table_books_list = document.getElementById("books-list");
            tbody = document.createElement("tbody");
            table_books_list.appendChild(tbody);

            var bookIndex;
            for(bookIndex = 0; bookIndex < books.length; bookIndex++){
                showABookResult(books[bookIndex]);
            }
        }

        function showABookResult(aBookResult){
            tr_a_book = document.createElement("tr");
            tbody.appendChild(tr_a_book);

            th_a_book_id = document.createElement("th");
            th_a_book_id.innerText = aBookResult.id;
            tr_a_book.appendChild(th_a_book_id);

            td_a_book_title = document.createElement("td");
            a_a_book_title = document.createElement("a");
            a_a_book_title.id = "title-" + aBookResult.id;
            a_a_book_title.innerText = aBookResult.title;
            a_a_book_title.setAttribute("data-toggle", "modal");
            a_a_book_title.setAttribute("href", "#book-view-modal");
            a_a_book_title.setAttribute("onClick", "onClickLinkBook(" + aBookResult.id + ")");
            td_a_book_title.appendChild(a_a_book_title);
            tr_a_book.appendChild(td_a_book_title);

            td_a_book_author = document.createElement("td");
            td_a_book_author.id = "author-" + aBookResult.id;
            td_a_book_author.innerText = aBookResult.author;
            tr_a_book.appendChild(td_a_book_author);
                        
        }


        var dataRequest, urlRequestAddOrEditBook, typeRequest, bookIdEdit;        


        // code to search all books when website is loaded complete   
        document.addEventListener("DOMContentLoaded", function(){
            searchBooks("");
        });

        var commentsList;

        function onClickLinkBook(bookId)
        {
            for(var bookIndex = 0; bookIndex < bookList.length; bookIndex++){
                if(bookList[bookIndex].id === bookId){
                    $("#title-book-view").text(bookList[bookIndex].title);
                    $("#author-book-view").text(bookList[bookIndex].author);
                    $("#description-book-view").text(bookList[bookIndex].description);
                    break;
                }
            }

            bookIdClicked = bookId;

            

            $("#comments-list").empty();
            callGetAllComments(bookId);     
        }

        function addComment(comment){
            div_comment = document.getElementById("comments-list"); 

            div_row_add_comment = document.createElement("div");
            div_row_add_comment.className = "row";
            div_comment.appendChild(div_row_add_comment);

            div_col_lg_1 = document.createElement("div");
            div_col_lg_1.className = "col-lg-1";
            div_col_lg_1.innerText = "ava";
            div_row_add_comment.appendChild(div_col_lg_1);

            div_col_lg_11 = document.createElement("div");
            div_col_lg_11.className = "col-lg-11";
            div_row_add_comment.appendChild(div_col_lg_11);

            div_header_comment = document.createElement("div");
            div_header_comment.className = "header-comment";
            div_header_comment.style = "display : inline;";
            div_col_lg_11.appendChild(div_header_comment);

            h6_header_comment_h6 = document.createElement("h6");
            h6_header_comment_h6.className = "header-comment-h6";
            div_header_comment.appendChild(h6_header_comment_h6);

            div_name_time = document.createElement("div");

            a_name = document.createElement("a");
            a_name.className = "name";
            a_name.style="color: #007bff; font-size: 18px";
            a_name.innerText = comment.user.firstName + " " + comment.user.lastName;
            div_name_time.appendChild(a_name)

            a_time = document.createElement("a");
            a_time.className = "time"
            a_time.style="margin-left: 15px;";
            a_time.innerText = timeDifferenceWithNow(new Date(comment.updatedAt));
            div_name_time.appendChild(a_time);

            h6_header_comment_h6.appendChild(div_name_time);

            h4_message = document.createElement("h4");
            h4_message.className = "message";
            h4_message.innerText = comment.message;
            div_col_lg_11.appendChild(h4_message);

            hr = document.createElement("hr");
            div_col_lg_11.appendChild(hr);

        }

        function callGetAllComments(bookId){

            $.ajax({
                type: "GET",
                contentType: "application/json",
                url: window.location.origin + "/api/book/" + bookId + "/comments" + "?sort=updatedAt,desc",
                dataType: 'json',
                timeout: 10000,
                success: function (dataReceive) {
                    commentsList = dataReceive.object.content;
                    
                    for(var index = 0; index < commentsList.length; index++){
                        addComment(commentsList[index]);
                    }

                    console.log(commentsList);
                },
                error: function (e) {
                    console.log("ERROR : ", e.responseJSON.message);
                }
            });
        }   

        var bookIdClicked;


    </script>

    <script>
        function timeDifferenceWithNow(previous) {
    
            var msPerMinute = 60 * 1000;
            var msPerHour = msPerMinute * 60;
            var msPerDay = msPerHour * 24;
            var msPerMonth = msPerDay * 30;
            var msPerYear = msPerDay * 365;
            
            var elapsed = (new Date()) - previous;
            
            if (elapsed < msPerMinute) {
                 return Math.round(elapsed/1000) + ' seconds ago';   
            }
            
            else if (elapsed < msPerHour) {
                 return Math.round(elapsed/msPerMinute) + ' minutes ago';   
            }
            
            else if (elapsed < msPerDay ) {
                 return Math.round(elapsed/msPerHour ) + ' hours ago';   
            }

            else if (elapsed < msPerMonth) {
                 return 'approximately ' + Math.round(elapsed/msPerDay) + ' days ago';   
            }
            
            else if (elapsed < msPerYear) {
                 return 'approximately ' + Math.round(elapsed/msPerMonth) + ' months ago';   
            }
            
            else {
                 return 'approximately ' + Math.round(elapsed/msPerYear ) + ' years ago';   
            }
        }
    </script>

    <style>
        .header-comment-h6{
            font-size: 15px;
        }
        .name{
            color: #0275d8;
        }
        .message{
            font-size: 16px;
        }
        #comment-input{
            border-radius: 1.25rem;
        }

        .form-group {
            margin-bottom: 0px;
        }

        label.error {
            color: red;
            font-style: italic;
            font-size: 12px;
        }
    </style>
</body>
</html>