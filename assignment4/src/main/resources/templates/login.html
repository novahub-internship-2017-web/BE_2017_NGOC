<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="/"><i class="fa fa-home" style="font-size: 26px"></i> Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="nav navbar-nav mr-auto"></ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#exampleModal" id="btn-sign-up">Sign up</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#exampleModal" id="btn-sign-in">Sign in</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="alert alert-success" id="alert-success-message" style="display: none; margin-top: 65px;">
        <p style="text-align: center; margin-bottom: 0px;">
            <strong>Success!</strong> You have successfully signed up as a user.
        </p>
    </div>


    <div class="modal" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="form-group">
                            <h2 style="text-align: center" id="form-title">Please Login</h2>
                        </div>                              
                        <div class="alert alert-danger" id="alert-error-message" style="display: none;">
                            <p style="text-align: center; margin-bottom: 0px;">
                                <strong>Danger!</strong> <span id="error-message"></span>.
                            </p>
                        </div>
                        <div class="form-group">
                            <label class="col-form-label">Email : </label>
                            <input type="text" name="email" id="email" class="form-control"/>
                        </div>
                        <div class="form-group">
                            <label class="col-form-label">Password : </label>
                            <input type="password" name="password" id="password" class="form-control"/>
                        </div>
                        <div class="form-group" id="group-repassword">
                            <label class="col-form-label">Comfirm password : </label>
                            <input type="password" name="repassword" id="re-password" class="form-control"/>
                        </div>
                        <div class="form-group" id="group-first-name">
                            <label class="col-form-label" >First name : </label>
                            <input type="text" name="firstName" id="first-name" class="form-control"/>
                        </div>
                        <div class="form-group" id="group-last-name">
                            <label class="col-form-label">Last name : </label>
                            <input type="text" name="lastName" id="last-name" class="form-control"/>
                        </div>
                        <div class="form-group" style="margin-top: 15px">
                            <input type="submit" name="submit" id="btn-action" class="btn btn-primary form-control"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.17.0/jquery.validate.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <style type="text/css">
        .form-group {
            margin-bottom: 0px;
        }

        label.error {
            color: red;
            font-style: italic;
            font-size: 12px;
        }
    </style>

    <script>
        const BTN_SIGN_UP_PRESSED = 1;
        const BTN_SIGN_IN_PRESSED = 2;


        const OK = 0;
        const EMAIL_IS_EXIST = 11;
        const EMAIL_OR_PASSWORD_WRONG = 12;
        const USER_IS_BLOCKED = 25;

        const ROLE_ADMIN = "ADMIN";
        const ROLE_USER = "USER";

        var stateButtonFormLoginPressed;

        $("#login-form").click( function(event){
            $("#alert-error-message").hide();
            $("#alert-success-message").hide();
        });

        $("#btn-sign-up").click( function(envet){
            $("#form-title").text("Please Sign Up");
            $("#re-password").prop("disabled", false);
            $("#first-name").prop("disabled", false);
            $("#last-name").prop("disabled", false);
            $("#group-repassword").show();
            $("#group-first-name").show();
            $("#group-last-name").show();
            $("#btn-action").val("Sign up");

            if(stateButtonFormLoginPressed != BTN_SIGN_UP_PRESSED){
                clearForm();
                clearErrorMessages();
            }
            stateButtonFormLoginPressed = BTN_SIGN_UP_PRESSED;
            
        });

        $("#btn-sign-in").click( function(envet){
            $("#form-title").text("Please Sign In");
            $("#re-password").prop("disabled", true);
            $("#first-name").prop("disabled", true);
            $("#last-name").prop("disabled", true);            
            $("#group-repassword").hide();
            $("#group-first-name").hide();
            $("#group-last-name").hide();
            $("#btn-action").val("Sign in");

            if(stateButtonFormLoginPressed != BTN_SIGN_IN_PRESSED){
                clearForm();
                clearErrorMessages(); 
            }            

            stateButtonFormLoginPressed = BTN_SIGN_IN_PRESSED;
            
        });

        function clearErrorMessages(){
            $("#alert-success-message").hide();
            $("#alert-error-message").hide();
            $(".error").hide();
            $("#email").css("border-color", "#ced4da");
            $("#password").css("border-color", "#ced4da");
            $("#repassword").css("border-color", "#ced4da");
            $("#firstName").css("border-color", "#ced4da");
            $("#lastName").css("border-color", "#ced4da");
        }

        function clearForm(){
            $(".error").hide();
            $("#email").val("");
            $("#email").css("border-color", "#ced4da");
            $("#password").val("");
            $("#password").css("border-color", "#ced4da");
            $("#repassword").val("");
            $("#repassword").css("border-color", "#ced4da");
            $("#firstName").val("");
            $("#firstName").css("border-color", "#ced4da");
            $("#lastName").val("");
            $("#lastName").css("border-color", "#ced4da");
        }

        $("#login-form").submit(function(event) {
            event.preventDefault();
            var data;

            if(stateButtonFormLoginPressed == BTN_SIGN_UP_PRESSED){
                data = JSON.stringify({
                    "email" : $('#email').val(),
                    "password" : $('#password').val(),
                    "firstName" : $('#first-name').val(),
                    "lastName" : $('#last-name').val()
                });
            }

            if($("#login-form").valid() ) {
                switch(stateButtonFormLoginPressed){
                    case BTN_SIGN_UP_PRESSED : 
                        {
                            $.ajax({
                                type: "POST",
                                contentType: "application/json",
                                url: window.location.origin + "/api/user",
                                data: data,
                                dataType: 'json',
                                timeout: 10000,
                                success: function (data) {
                                    switch(data.code)
                                    {
                                        case OK:
                                            {                                                
                                                clearForm();    
                                                $("#exampleModal").modal('hide'); 
                                                $("#alert-success-message").show();
                                                $("#alert-error-message").hide();
                                            }
                                            break;

                                        case EMAIL_IS_EXIST:
                                            {
                                                $("#alert-error-message").show();
                                                $("#alert-success-message").hide();
                                                $("#error-message").text("Email is exist");
                                            }
                                            break;

                                        
                                    }
                                                                   
                                },
                                error: function (e) {
                                    // TODO: show message network 
                                }
                            });
                        }
                        break;
                    case BTN_SIGN_IN_PRESSED :
                        {
                            $.ajax({
                                type: "GET",
                                contentType: "application/json",
                                url: window.location.origin + "/api/user",
                                headers: 
                                {
                                    "email"     : $('#email').val(), 
                                    "password"  : $('#password').val()
                                },
                                dataType: 'json',
                                timeout: 10000,
                                success: function (data) {
                                    switch(data.code)
                                    {
                                        case OK:
                                            {                                                
                                                if(data.object.name == ROLE_ADMIN){
                                                    window.location.replace(window.location.origin + "/admin/home");
                                                } 

                                                if(data.object.name == ROLE_USER){
                                                    window.location.replace(window.location.origin + "/user/home");
                                                }
                                            }
                                            break;

                                        case EMAIL_OR_PASSWORD_WRONG:
                                            {
                                                $("#alert-error-message").show();
                                                $("#alert-success-message").hide();
                                                $("#error-message").text("Email or Password incorrect");
                                            }
                                            break;

                                        case USER_IS_BLOCKED:
                                            {
                                                $("#alert-error-message").show();
                                                $("#alert-success-message").hide();
                                                $("#error-message").text("User is blocked");
                                            }
                                            break;
                                    }
                                },
                                error: function (e) {
                                    $("#alert-error-message").show();
                                    $("#alert-success-message").hide();
                                    $("#error-message").text(e.responseJSON.message.trim());
                                }
                            });
                        }
                        break;
                }
            }
        });

        // validation
        $(document).ready(function(s) {
            $("#login-form").validate({
                highlight : 
                    function(element, errorClass) {
                        $(element).css("border-color", "#d9534f");
                    },
                unhighlight : 
                    function(element, errorClass) {
                        $(element).css("border-color", "#5cb85c");
                    },
                rules:{
                    email : {
                        required: true,
                        email: true
                    },
                    password: {
                        required: true
                    },
                    repassword: {
                        equalTo: "#password"
                    }
                },
                messages :{
                    email : {
                        required: "Email is not empty",
                        email: "Your email address must be in the format of name@domain.com"
                    },
                    password: {
                        required: "Password is not empty"
                    },
                    repassword: {
                        equalTo: "Password does not match the confirm password"
                    }
                }
            });
        });

    </script> 
</body>
</html>